{% extends 'web/base.html' %}
{% load humanize %}

{% block title %}Báo Cáo - MoneyFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-graph-up"></i> Báo Cáo & Phân Tích</h2>
        <p class="text-muted">Phân tích chi tiết về tình hình tài chính</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-label">Tổng Thu Nhập</div>
            <div class="stat-value income">
                {{ summary.total_income|default:0|floatformat:0|intcomma }} đ
            </div>
            <small class="text-muted">Tháng này</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-label">Tổng Chi Tiêu</div>
            <div class="stat-value expense">
                {{ summary.total_expense|default:0|floatformat:0|intcomma }} đ
            </div>
            <small class="text-muted">Tháng này</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-label">Số Dư</div>
            <div class="stat-value {% if summary.balance >= 0 %}income{% else %}expense{% endif %}">
                {{ summary.balance|default:0|floatformat:0|intcomma }} đ
            </div>
            <small class="text-muted">Tháng này</small>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pie-chart"></i> Chi Tiêu Theo Danh Mục
            </div>
            <div class="card-body">
                {% if breakdown %}
                <canvas id="categoryChart" height="300"></canvas>
                {% else %}
                <p class="text-center text-muted py-5">Chưa có dữ liệu</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-check"></i> Chi Tiết Theo Danh Mục
            </div>
            <div class="card-body">
                {% if breakdown %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Danh mục</th>
                                <th class="text-end">Số tiền</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in breakdown %}
                            <tr>
                                <td>{{ item.category_name }}</td>
                                <td class="text-end">{{ item.amount|floatformat:0|intcomma }} đ</td>
                                <td class="text-end">{{ item.percentage|floatformat:1 }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted py-5">Chưa có dữ liệu</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> So Sánh 6 Tháng Gần Đây
            </div>
            <div class="card-body">
                {% if monthly %}
                <canvas id="monthlyChart" height="100"></canvas>
                {% else %}
                <p class="text-center text-muted py-5">Chưa có dữ liệu</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-table"></i> Bảng So Sánh Tháng
            </div>
            <div class="card-body">
                {% if monthly %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tháng</th>
                                <th class="text-end">Thu nhập</th>
                                <th class="text-end">Chi tiêu</th>
                                <th class="text-end">Chênh lệch</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTableBody">
                            {% for item in monthly %}
                            <tr>
                                <td>{{ item.month }}</td>
                                <td class="text-end income">{{ item.total_income|floatformat:0|intcomma }} đ</td>
                                <td class="text-end expense">{{ item.total_expense|floatformat:0|intcomma }} đ</td>
                                <td class="text-end balance" data-income="{{ item.total_income }}" data-expense="{{ item.total_expense }}">
                                    <span class="balance-value">-</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted py-5">Chưa có dữ liệu</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Parse analytics data from JSON
const summaryData = {{ summary_json|safe }};
const breakdownData = {{ breakdown_json|safe }};
const monthlyData = {{ monthly_json|safe }};

console.log('Analytics summary:', summaryData);
console.log('Analytics breakdown:', breakdownData);
console.log('Analytics monthly:', monthlyData);

// Category Breakdown Pie Chart
{% if breakdown %}
const categoryData = breakdownData || [];
console.log('Analytics category data:', categoryData);

// Filter only expense categories for the pie chart
const expenseData = categoryData.filter(item => item.type === 'expense');
console.log('Expense data:', expenseData);

if (expenseData && expenseData.length > 0) {
    const ctx1 = document.getElementById('categoryChart');
    if (ctx1) {
        new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: expenseData.map(item => item.category_name),
                datasets: [{
                    data: expenseData.map(item => item.amount),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += new Intl.NumberFormat('vi-VN').format(context.parsed);
                                label += ' đ (' + expenseData[context.dataIndex].percentage.toFixed(1) + '%)';
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
} else {
    console.log('No expense data available');
    const categoryChart = document.getElementById('categoryChart');
    if (categoryChart) {
        categoryChart.parentElement.innerHTML = '<p class="text-center text-muted py-5">Chưa có dữ liệu chi tiêu</p>';
    }
}
{% endif %}

// Monthly Comparison Bar Chart
{% if monthly %}
console.log('Analytics monthly data:', monthlyData);

if (monthlyData && monthlyData.length > 0) {
    const ctx2 = document.getElementById('monthlyChart');
    if (ctx2) {
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: monthlyData.map(item => item.month),
                datasets: [
                    {
                        label: 'Thu nhập',
                        data: monthlyData.map(item => item.total_income),
                        backgroundColor: '#4CAF50'
                    },
                    {
                        label: 'Chi tiêu',
                        data: monthlyData.map(item => item.total_expense),
                        backgroundColor: '#f44336'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += new Intl.NumberFormat('vi-VN').format(context.parsed.y);
                                label += ' đ';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN').format(value) + ' đ';
                            }
                        }
                    }
                }
            }
        });
    }
} else {
    console.log('No monthly data available');
    const monthlyChart = document.getElementById('monthlyChart');
    if (monthlyChart) {
        monthlyChart.parentElement.innerHTML = '<p class="text-center text-muted py-5">Chưa có dữ liệu tháng</p>';
    }
}
{% endif %}

// Calculate balance for monthly table
document.addEventListener('DOMContentLoaded', function() {
    const balanceCells = document.querySelectorAll('.balance');
    balanceCells.forEach(cell => {
        const income = parseFloat(cell.dataset.income) || 0;
        const expense = parseFloat(cell.dataset.expense) || 0;
        const balance = income - expense;
        
        const balanceValue = cell.querySelector('.balance-value');
        balanceValue.textContent = new Intl.NumberFormat('vi-VN').format(balance) + ' đ';
        
        // Add color class
        if (balance >= 0) {
            cell.classList.add('income');
        } else {
            cell.classList.add('expense');
        }
    });
});
</script>
{% endblock %}

